name: Node.js CI

on:
  push:
    branches: [ "main", "XOPS-*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout do repositório
      - name: Checkout do repositório
        uses: actions/checkout@v4

      # 2) Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3) Instalar dependências
      - name: Instalar dependências
        run: npm ci

      # 4) Lint (análise estática de estilo)
      - name: Correr lint
        run: npm run lint

      # 5) Testes Jest com cobertura
      - name: Correr testes Jest com cobertura
        run: npm test

      # 6) DAST – testes de segurança dinâmicos
      - name: Correr testes DAST
        run: npm run dast

      # 7) Guardar relatório de cobertura (artefacto)
      - name: Guardar relatório de cobertura
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage

      # 8) AI code review (quality gate)
      - name: AI code review (XOPS-23)
        run: npm run ai-review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # 9) AI SAST Security Gate
      - name: AI SAST security gate (XOPS-23)
        run: npm run ai-sast
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
